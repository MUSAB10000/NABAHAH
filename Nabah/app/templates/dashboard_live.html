<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/dashboard_style.css" />
  <title>Live Monitoring | Nabah</title>
  <style>
    body {
      background-color: #1c1e25;
      color: white;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
    }

    .user-dropdown {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 30px;
    }
    .user-name {
      cursor: pointer;
      padding: 10px 16px;
      background: #2e323c;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 180px;
      text-align: center;
      font-weight: 600;
      color: #fff;
    }
    .user-name::after {
      content: "⌄";
      font-size: 14px;
      color: #aaa;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      bottom: 45px;
      background-color: #ffffff;
      min-width: 120px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.15);
      border-radius: 8px;
      text-align: center;
      z-index: 9999;
    }
    .dropdown-content a {
      color: #333;
      padding: 10px;
      display: block;
      text-decoration: none;
      border-bottom: 1px solid #eee;
    }
    .dropdown-content a:hover { background-color: #f2f2f2; }

    .muted { color: #aaa; font-size: 13px; }
    .card {
      background-color: #2e323c;
      border-radius: 16px;
      padding: 25px;
      flex: 1;
      min-width: 360px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      margin-top: 25px;
    }
    .btn {
      background-color: #077E71;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn:hover { background-color: #09997d; }
    .btn.secondary {
      background-color: #1f232b;
      border: 1px solid #077E71;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .chip {
      background-color: #333;
      padding: 6px 10px;
      border-radius: 8px;
      display: inline-block;
    }
    select, input[type="file"] {
      padding: 8px 10px;
      border-radius: 8px;
      background: #2e323c;
      color: #fff;
      border: 1px solid rgba(255,255,255,.1);
    }
    .progress-container {
      background: #1f232b;
      border-radius: 8px;
      margin-top: 12px;
      height: 12px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #077E71;
      transition: width 0.3s ease;
    }

    /* ✅ ضبط اللوقو داخل الشريط الجانبي */
    .frame-3 {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 25px;
    }
    .image {
      width: 110px;
      margin-bottom: 10px;
      height: auto;
      display: block;
    }
  </style>
</head>

<body>
  <div class="home">
    <!-- Sidebar -->
    <div class="frame">
      <div class="frame-2">
        <div class="frame-3">
          <img class="image" src="https://c.animaapp.com/eXlg37cB/img/logo1_1.png" />
          <div class="frame-4">
            <div class="frame-5"><p class="p">Where intelligence meets laboratory safety</p></div>
          </div>
        </div>

        <!-- ✅ هنا كان الخطأ (تمت إزالة الإغلاق الزائد) -->
        <div class="group-2">
          <a href="/dashboard/overview"><button class="side-btn">Dashboard</button></a>
          <a href="/dashboard/live"><button class="side-btn active">Live Monitoring</button></a>
          <a href="/dashboard/database"><button class="side-btn">Database</button></a>
          <a href="/dashboard/settings"><button class="side-btn">Settings</button></a>
        </div>
      </div>

      <div class="frame-13">
        <div class="user-dropdown" id="userMenuToggle">
          <div class="user-name">Mawda</div>
          <div class="dropdown-content" id="userDropdown">
            <a href="/logout">Log out</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="content">
      <h2>Live Monitoring</h2>
      <p class="muted">Upload recorded videos or connect live camera streams.</p>

      <div class="cards">
        <!-- Upload Video -->
        <div class="card">
          <h3>Upload Video</h3>
          <p class="muted">Analyze a recorded video file.</p>

          <div class="row">
            <label for="analysisType">Choose Analysis Type:</label>
            <select id="analysisType">
              <option value="ppe">All PPE Detection</option>
              <option value="spill">Spill Detection Only</option>
              <option value="both">Both (PPE + Spill)</option>
            </select>
          </div>

          <div class="row">
            <input type="file" id="videoFile" accept="video/*">
            <button class="btn" id="analyzeBtn">Analyze</button>
          </div>

          <div class="progress-container" id="uploadProgress"><div class="progress-bar" id="uploadBar"></div></div>
          <div class="progress-container" id="processProgress" style="display:none;"><div class="progress-bar" id="processBar"></div></div>

          <div id="videoResult" style="margin-top:12px;">
            <span class="chip">Status: waiting...</span>
          </div>
        </div>

        <!-- Stream Cameras -->
        <div class="card">
          <h3>Stream Cameras</h3>
          <p class="muted">Connect to live camera feeds.</p>
          <div class="row">
            <button class="btn secondary" id="startStreamBtn">Start Preview</button>
            <button class="btn secondary" id="stopStreamBtn">Stop</button>
          </div>
          <div id="streamPreview" style="margin-top:12px; height:240px; background:#1f232b; border-radius:10px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(255,255,255,.15);">
            <span class="muted">Preview will appear here</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dropdown menu
    const toggle=document.getElementById("userMenuToggle");
    const dropdown=document.getElementById("userDropdown");
    toggle.addEventListener("click",()=>{
      const open=dropdown.style.display==="block";
      dropdown.style.display=open?"none":"block";
      toggle.classList.toggle("open",!open);
    });
    document.addEventListener("click",(e)=>{
      if(!document.querySelector(".user-dropdown").contains(e.target)){
        dropdown.style.display="none";
        toggle.classList.remove("open");
      }
    });

    // ✅ Upload & analyze
    const analyzeBtn=document.getElementById("analyzeBtn");
    const videoFile=document.getElementById("videoFile");
    const videoResult=document.getElementById("videoResult");
    const uploadBar=document.getElementById("uploadBar");
    const processBar=document.getElementById("processBar");
    const uploadProgress=document.getElementById("uploadProgress");
    const processProgress=document.getElementById("processProgress");
    const analysisTypeSel=document.getElementById("analysisType");

    analyzeBtn?.addEventListener("click",async()=>{
      const file=videoFile?.files?.[0];
      if(!file){alert("Please choose a video first!");return;}

      videoResult.innerHTML=`<span class="chip">Uploading video...</span>`;
      uploadBar.style.width="0%";
      processBar.style.width="0%";
      processProgress.style.display="none";

      for(let i=0;i<=100;i+=5){await new Promise(r=>setTimeout(r,40));uploadBar.style.width=i+"%";}
      videoResult.innerHTML=`<span class="chip">Processing model...</span>`;
      processProgress.style.display="block";
      for(let i=0;i<=100;i+=2){await new Promise(r=>setTimeout(r,60));processBar.style.width=i+"%";}

      const formData=new FormData();
      formData.append("file",file);
      const cleanType=analysisTypeSel.value.trim().toLowerCase();
      formData.append("analysis_type",cleanType);

      try{
        const res=await fetch("/api/analyze-video",{method:"POST",body:formData});
        const data=await res.json();
        if(data.error){
          videoResult.innerHTML=`<span class="chip">❌ Error: ${data.error}</span>`;
        }
        else if(data.status==="success"){
          const downloadUrl = data.download_url;
          videoResult.innerHTML = `
            <span class="chip">✅ Analysis Complete!</span>
            <br><p class="muted">Type: ${cleanType}</p>
            <p class="muted">Video ID: ${data.video_id}</p>
            <button class="btn" id="downloadBtn" style="margin-top:10px;">⬇️ Download Processed Video</button>
          `;
          document.getElementById("downloadBtn").addEventListener("click",()=>{
            const a=document.createElement("a");
            a.href=downloadUrl;
            a.download="";
            a.click();
          });
        }else{
          videoResult.innerHTML=`<span class="chip">⚠️ Unexpected response.</span>`;
        }
      }catch(err){
        console.error("Error:",err);
        videoResult.innerHTML=`<span class="chip">❌ Failed: ${err.message}</span>`;
      }
    });

    // ✅ Live camera streaming
    const preview = document.getElementById("streamPreview");

    document.getElementById("startStreamBtn").addEventListener("click", () => {
      preview.innerHTML = `
        <img src="/video_feed"
             style="width:100%;height:100%;object-fit:cover;border-radius:10px;"
             alt="Live stream not available"/>`;
    });

    document.getElementById("stopStreamBtn").addEventListener("click", async () => {
      await fetch("/stop_feed");
      preview.innerHTML = `<span class='muted'>Preview stopped.</span>`;
    });
  </script>
</body>
</html>
